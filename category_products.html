<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Products | iBlue Commerce</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #003cff;
      --primary-dark: #0028cc;
      --secondary: #6c757d;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border: #dee2e6;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      padding-bottom: 80px; /* Space for mobile filter bar */
    }

    /* Mobile-First Header */
    .main-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: white;
      flex-shrink: 0;
    }

    .logo i {
      font-size: 1.5rem;
    }

    .logo-text {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .search-bar {
      flex: 1;
      min-width: 0; /* Allow flex item to shrink below content size */
    }

    .search-bar input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border: none;
      border-radius: 20px;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.9);
    }

    .search-bar i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 0.9rem;
    }

    .mobile-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mobile-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      position: relative;
      flex-shrink: 0;
    }

    .cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Mobile Navigation */
    .mobile-nav {
      display: flex;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 10px 15px;
      gap: 10px;
      position: sticky;
      top: 67px;
      z-index: 999;
    }

    .mobile-nav::-webkit-scrollbar {
      display: none;
    }

    .nav-btn {
      padding: 8px 15px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--dark);
      text-decoration: none;
      font-size: 0.85rem;
      white-space: nowrap;
      flex-shrink: 0;
      transition: all 0.3s;
    }

    .nav-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      font-weight: 500;
    }

    /* Floating Filter Bar */
    .filter-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 50px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 1000;
      width: 90%;
      max-width: 500px;
    }

    .filter-scroll {
      display: flex;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      gap: 10px;
      flex: 1;
    }

    .filter-scroll::-webkit-scrollbar {
      display: none;
    }

    .filter-chip {
      padding: 6px 12px;
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.8rem;
      white-space: nowrap;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }

    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .filter-btn {
      background: var(--primary);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    /* Products Grid */
    .products-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .products-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .results-count {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .sort-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      font-size: 0.9rem;
      min-width: 140px;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    /* Product Card for Mobile - UPDATED FOR LARGER IMAGES */
    .product-card {
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .product-image {
      position: relative;
      padding-top: 85%; /* Larger image area like Amazon */
      overflow: hidden;
      background: #f8f9fa;
    }

    .product-image img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain; /* Changed to contain for better product visibility */
      padding: 15px;
      transition: transform 0.5s ease;
    }

    .product-card:hover .product-image img {
      transform: scale(1.05);
    }

    .product-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
      z-index: 2;
    }

    .badge-sale {
      background: var(--danger);
    }

    .badge-featured {
      background: var(--warning);
    }

    .badge-out {
      background: var(--gray);
    }

    .product-info {
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
      border-top: 1px solid var(--border);
    }

    .product-category {
      color: var(--gray);
      font-size: 0.8rem;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .product-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 10px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 2.8em;
    }

    .product-title a {
      color: inherit;
      text-decoration: none;
    }

    .product-title a:hover {
      color: var(--primary);
    }

    .product-price {
      margin-top: auto;
      margin-bottom: 15px;
    }

    .current-price {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .original-price {
      font-size: 0.85rem;
      color: var(--gray);
      text-decoration: line-through;
      margin-left: 8px;
    }

    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }

    .btn-details {
      flex: 1;
      padding: 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      text-align: center;
      transition: background 0.3s ease;
    }

    .btn-details:hover {
      background: var(--primary-dark);
    }

    .btn-details:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }

    /* Loading State */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      grid-column: 1 / -1;
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(0, 60, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      grid-column: 1 / -1;
    }

    .empty-state i {
      font-size: 3rem;
      color: var(--light-gray);
      margin-bottom: 15px;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--dark);
    }

    .empty-state p {
      color: var(--gray);
      margin-bottom: 20px;
    }

    /* Modal for Filters */
    .filter-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: none;
      align-items: flex-end;
    }

    .filter-modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: white;
      z-index: 2;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-section {
      margin-bottom: 25px;
    }

    .modal-section h4 {
      font-size: 1rem;
      margin-bottom: 15px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filter-option {
      padding: 8px 16px;
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .filter-option.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .price-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .price-inputs input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
    }

    .modal-actions {
      padding: 20px;
      display: flex;
      gap: 10px;
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 1px solid var(--border);
    }

    .btn-apply {
      flex: 1;
      padding: 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
    }

    .btn-clear {
      flex: 1;
      padding: 15px;
      background: var(--light);
      color: var(--dark);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
    }

    /* Desktop Styles */
    @media (min-width: 768px) {
      body {
        padding-bottom: 0;
      }

      .main-header {
        padding: 20px 0;
      }

      .header-content {
        padding: 0 20px;
      }

      .logo i {
        font-size: 2rem;
      }

      .logo-text {
        font-size: 1.5rem;
      }

      .mobile-nav {
        display: none; /* Hide mobile nav on desktop */
      }

      .filter-bar {
        position: sticky;
        top: 85px;
        left: 0;
        transform: none;
        max-width: none;
        width: auto;
        margin: 20px 20px 0;
        border-radius: var(--radius);
        padding: 15px 20px;
      }

      .products-container {
        padding: 20px;
      }

      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
      }

      .product-card {
        min-height: 420px;
      }

      .product-image {
        padding-top: 80%;
      }
    }

    @media (min-width: 1024px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      }
      
      .filter-bar {
        margin: 20px auto 0;
        width: 95%;
        max-width: 1200px;
      }

      .product-card {
        min-height: 450px;
      }
    }

    /* Tablet Styles */
    @media (min-width: 768px) and (max-width: 1023px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <header class="main-header">
    <div class="header-content">
      <a href="index.html" class="logo">
        <i class="fas fa-shopping-bag"></i>
        <span class="logo-text">iBlue</span>
      </a>
      
      <div class="search-bar" style="position: relative;">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search products...">
      </div>
      
      <div class="mobile-actions">
        <a href="login.html" class="mobile-btn" title="Account">
          <i class="fas fa-user"></i>
        </a>
        <a href="cart.html" class="mobile-btn" title="Cart">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-count" id="cartCount">0</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Mobile Navigation -->
  <nav class="mobile-nav">
    <a href="index.html" class="nav-btn">Home</a>
    <a href="products.html" class="nav-btn active">Products</a>
    <a href="deals.html" class="nav-btn">Deals</a>
    <a href="new.html" class="nav-btn">New</a>
    <a href="categories.html" class="nav-btn">Categories</a>
    <a href="sale.html" class="nav-btn">Sale</a>
  </nav>

  <!-- Floating Filter Bar -->
  <div class="filter-bar">
    <div class="filter-scroll" id="filterScroll">
      <!-- Filter chips will be added here -->
    </div>
    <button class="filter-btn" onclick="openFilterModal()">
      <i class="fas fa-sliders-h"></i>
    </button>
  </div>

  <!-- Main Content -->
  <div class="products-container">
    <div class="products-header">
      <div>
        <h2 style="font-size: 1.3rem; margin-bottom: 5px;">All Products</h2>
        <p class="results-count" id="resultsCount">Loading...</p>
      </div>
      <select class="sort-select" id="sortSelect" onchange="sortProducts()">
        <option value="newest">Newest</option>
        <option value="price_low">Price: Low to High</option>
        <option value="price_high">Price: High to Low</option>
        <option value="name">Name: A-Z</option>
      </select>
    </div>

    <!-- Products Grid -->
    <div class="products-grid" id="productsGrid">
      <!-- Products will be loaded here -->
    </div>

    <!-- Loading State -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <i class="fas fa-search"></i>
      <h3>No Products Found</h3>
      <p>Try adjusting your search or filter to find what you're looking for.</p>
    </div>
  </div>

  <!-- Filter Modal -->
  <div class="filter-modal" id="filterModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="font-size: 1.2rem;">Filter Products</h3>
        <button onclick="closeFilterModal()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <!-- Category Filter -->
        <div class="modal-section">
          <h4><i class="fas fa-list"></i> Category</h4>
          <div class="filter-grid" id="categoryFilters">
            <!-- Categories will be loaded here -->
          </div>
        </div>
        
        <!-- Price Filter -->
        <div class="modal-section">
          <h4><i class="fas fa-money-bill-wave"></i> Price Range (UGX)</h4>
          <div class="price-inputs">
            <div>
              <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--gray);">Min</label>
              <input type="number" id="minPrice" placeholder="0" min="0">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--gray);">Max</label>
              <input type="number" id="maxPrice" placeholder="100000" min="0">
            </div>
          </div>
        </div>
        
        <!-- Status Filter -->
        <div class="modal-section">
          <h4><i class="fas fa-check-circle"></i> Status</h4>
          <div class="filter-grid">
            <div class="filter-option" onclick="toggleFilter(this, 'in_stock')">
              <i class="fas fa-check" style="margin-right: 5px;"></i> In Stock
            </div>
            <div class="filter-option" onclick="toggleFilter(this, 'featured')">
              <i class="fas fa-star" style="margin-right: 5px;"></i> Featured
            </div>
            <div class="filter-option" onclick="toggleFilter(this, 'on_sale')">
              <i class="fas fa-tag" style="margin-right: 5px;"></i> On Sale
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-clear" onclick="clearFilters()">
          Clear All
        </button>
        <button class="btn-apply" onclick="applyModalFilters()">
          Apply Filters
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // Initialize Supabase client
    const supabaseUrl = "https://amxhpxqakqrjjihwkzcq.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFteGhweHFha3FyamppaHdremNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5Nzc2NjUsImV4cCI6MjA4MzU1MzY2NX0.yIAZtz3bUc_ZxF8-f4cqW1fKJgFiRsiJdj4qgCDmM0g";
    
    const sb = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Global variables
    let allProducts = [];
    let filteredProducts = [];
    let currentFilters = {
      category: null,
      minPrice: 0,
      maxPrice: 100000,
      inStock: false,
      featured: false,
      onSale: false,
      search: ''
    };
    let currentSort = 'newest';

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadProducts();
      updateCartCount();
      setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
      // Search input
      document.getElementById('searchInput').addEventListener('input', debounce(function(e) {
        currentFilters.search = e.target.value.toLowerCase();
        applyFilters();
      }, 300));
    }

    // Load products from Supabase - FIXED VERSION
    async function loadProducts() {
      const loading = document.getElementById('loading');
      const productsGrid = document.getElementById('productsGrid');
      const emptyState = document.getElementById('emptyState');
      
      loading.style.display = 'flex';
      productsGrid.innerHTML = '';
      emptyState.style.display = 'none';
      
      try {
        console.log('Loading products from Supabase...');
        
        // Fetch all products without filters first to see what we get
        const { data: products, error } = await sb
          .from('products_new')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50); // Limit for testing
          
        console.log('Products fetched:', products);
        
        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }
        
        if (!products || products.length === 0) {
          console.log('No products found in database');
          emptyState.style.display = 'block';
          document.getElementById('resultsCount').textContent = '0 products';
          loading.style.display = 'none';
          return;
        }
        
        // Process products with safe defaults
        allProducts = products.map(product => {
          // Ensure price and discount_price are numbers
          const price = parseFloat(product.price) || 0;
          const discountPrice = product.discount_price ? parseFloat(product.discount_price) : null;
          
          return {
            ...product,
            price: price,
            discount_price: discountPrice,
            // Ensure stock_quantity is a number
            stock_quantity: parseInt(product.stock_quantity) || 0
          };
        });
        
        console.log('Processed products:', allProducts);
        
        filteredProducts = [...allProducts];
        
        // Load categories
        loadCategories(allProducts);
        
        // Apply initial filters
        applyFilters();
        
      } catch (error) {
        console.error('Error loading products:', error);
        productsGrid.innerHTML = `
          <div class="empty-state" style="display: block; grid-column: 1 / -1;">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Error Loading Products</h3>
            <p>Please check console for details.</p>
            <p><small>${error.message}</small></p>
          </div>
        `;
      } finally {
        loading.style.display = 'none';
      }
    }

    // Load categories from products
    function loadCategories(products) {
      const categoryFilters = document.getElementById('categoryFilters');
      const filterScroll = document.getElementById('filterScroll');
      
      // Get unique categories
      const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
      
      console.log('Categories found:', categories);
      
      // Clear existing filters
      categoryFilters.innerHTML = '';
      filterScroll.innerHTML = '';
      
      // Add "All Categories" option
      const allOption = document.createElement('div');
      allOption.className = 'filter-option active';
      allOption.textContent = 'All Categories';
      allOption.onclick = function() {
        setActiveCategory(this, null);
      };
      categoryFilters.appendChild(allOption);
      
      // Add category chips to scrollable bar
      const allChip = document.createElement('div');
      allChip.className = 'filter-chip active';
      allChip.innerHTML = '<i class="fas fa-layer-group"></i> All';
      allChip.onclick = function() {
        setActiveCategory(this, null);
        updateFilterChips();
      };
      filterScroll.appendChild(allChip);
      
      // Add each category
      categories.forEach(category => {
        // Modal filter option
        const option = document.createElement('div');
        option.className = 'filter-option';
        option.textContent = category;
        option.onclick = function() {
          setActiveCategory(this, category);
        };
        categoryFilters.appendChild(option);
        
        // Scrollable chip
        const chip = document.createElement('div');
        chip.className = 'filter-chip';
        chip.innerHTML = `<i class="fas fa-tag"></i> ${category}`;
        chip.onclick = function() {
          setActiveCategory(this, category);
          updateFilterChips();
        };
        filterScroll.appendChild(chip);
      });
      
      // Add status chips
      const statusChips = [
        { icon: 'check', label: 'In Stock', filter: 'in_stock' },
        { icon: 'star', label: 'Featured', filter: 'featured' },
        { icon: 'tag', label: 'On Sale', filter: 'on_sale' }
      ];
      
      statusChips.forEach(status => {
        const chip = document.createElement('div');
        chip.className = 'filter-chip';
        chip.innerHTML = `<i class="fas fa-${status.icon}"></i> ${status.label}`;
        chip.onclick = function() {
          toggleFilter(this, status.filter);
        };
        filterScroll.appendChild(chip);
      });
    }

    // Set active category
    function setActiveCategory(element, category) {
      // Remove active class from all category options
      document.querySelectorAll('#categoryFilters .filter-option').forEach(opt => {
        opt.classList.remove('active');
      });
      
      // Add active class to clicked option
      element.classList.add('active');
      
      // Update filter
      currentFilters.category = category;
      
      // Apply filters immediately
      applyFilters();
    }

    // Toggle filter
    function toggleFilter(element, filterType) {
      element.classList.toggle('active');
      
      switch(filterType) {
        case 'in_stock':
          currentFilters.inStock = element.classList.contains('active');
          break;
        case 'featured':
          currentFilters.featured = element.classList.contains('active');
          break;
        case 'on_sale':
          currentFilters.onSale = element.classList.contains('active');
          break;
      }
      
      updateFilterChips();
      applyFilters(); // Apply filters immediately
    }

    // Update filter chips
    function updateFilterChips() {
      const chips = document.querySelectorAll('#filterScroll .filter-chip');
      chips.forEach(chip => {
        // Update category chips
        if (chip.textContent.includes('All')) {
          chip.classList.toggle('active', currentFilters.category === null);
        } else if (chip.textContent.includes('In Stock')) {
          chip.classList.toggle('active', currentFilters.inStock);
        } else if (chip.textContent.includes('Featured')) {
          chip.classList.toggle('active', currentFilters.featured);
        } else if (chip.textContent.includes('On Sale')) {
          chip.classList.toggle('active', currentFilters.onSale);
        } else if (currentFilters.category) {
          chip.classList.toggle('active', chip.textContent.includes(currentFilters.category));
        }
      });
    }

    // Apply filters - FIXED VERSION
    function applyFilters() {
      console.log('Applying filters:', currentFilters);
      console.log('Total products:', allProducts.length);
      
      filteredProducts = allProducts.filter(product => {
        // Search filter
        if (currentFilters.search) {
          const searchLower = currentFilters.search.toLowerCase();
          const nameMatch = product.name ? product.name.toLowerCase().includes(searchLower) : false;
          const descMatch = product.description ? product.description.toLowerCase().includes(searchLower) : false;
          
          if (!nameMatch && !descMatch) {
            return false;
          }
        }
        
        // Category filter
        if (currentFilters.category && product.category !== currentFilters.category) {
          return false;
        }
        
        // Price filter
        const price = product.discount_price || product.price || 0;
        if (price < currentFilters.minPrice || price > currentFilters.maxPrice) {
          console.log(`Product ${product.name} filtered by price: ${price} not in range ${currentFilters.minPrice}-${currentFilters.maxPrice}`);
          return false;
        }
        
        // Stock filter
        if (currentFilters.inStock && (product.stock_quantity <= 0 || !product.stock_quantity)) {
          return false;
        }
        
        // Featured filter
        if (currentFilters.featured && !product.featured) {
          return false;
        }
        
        // Sale filter
        if (currentFilters.onSale && !product.discount_price) {
          return false;
        }
        
        return true;
      });
      
      console.log('Products after filtering:', filteredProducts.length);
      
      // Sort products
      sortProducts();
      
      // Update results count
      document.getElementById('resultsCount').textContent = 
        `${filteredProducts.length} product${filteredProducts.length !== 1 ? 's' : ''}`;
      
      // Render products
      renderProducts();
    }

    // Apply filters from modal
    function applyModalFilters() {
      const minPrice = document.getElementById('minPrice').value;
      const maxPrice = document.getElementById('maxPrice').value;
      
      currentFilters.minPrice = minPrice ? parseFloat(minPrice) : 0;
      currentFilters.maxPrice = maxPrice ? parseFloat(maxPrice) : 100000;
      
      console.log('Modal filters applied:', currentFilters.minPrice, currentFilters.maxPrice);
      
      applyFilters();
      closeFilterModal();
    }

    // Clear all filters
    function clearFilters() {
      console.log('Clearing all filters');
      
      // Reset filter state
      currentFilters = {
        category: null,
        minPrice: 0,
        maxPrice: 100000,
        inStock: false,
        featured: false,
        onSale: false,
        search: ''
      };
      
      // Reset UI
      document.getElementById('searchInput').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      document.getElementById('sortSelect').value = 'newest';
      
      // Remove active classes
      document.querySelectorAll('.filter-option.active, .filter-chip.active').forEach(el => {
        el.classList.remove('active');
      });
      
      // Set "All Categories" as active
      const firstOption = document.querySelector('#categoryFilters .filter-option:first-child');
      const firstChip = document.querySelector('#filterScroll .filter-chip:first-child');
      
      if (firstOption) firstOption.classList.add('active');
      if (firstChip) firstChip.classList.add('active');
      
      applyFilters();
      closeFilterModal();
    }

    // Sort products
    function sortProducts() {
      const sortBy = document.getElementById('sortSelect').value;
      currentSort = sortBy;
      
      console.log('Sorting by:', sortBy);
      
      if (sortBy === 'newest') {
        filteredProducts.sort((a, b) => {
          const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
          const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
          return dateB - dateA;
        });
      } else if (sortBy === 'price_low') {
        filteredProducts.sort((a, b) => {
          const priceA = a.discount_price || a.price || 0;
          const priceB = b.discount_price || b.price || 0;
          return priceA - priceB;
        });
      } else if (sortBy === 'price_high') {
        filteredProducts.sort((a, b) => {
          const priceA = a.discount_price || a.price || 0;
          const priceB = b.discount_price || b.price || 0;
          return priceB - priceA;
        });
      } else if (sortBy === 'name') {
        filteredProducts.sort((a, b) => {
          const nameA = a.name || '';
          const nameB = b.name || '';
          return nameA.localeCompare(nameB);
        });
      }
      
      renderProducts();
    }

    // Render products - FIXED VERSION
    function renderProducts() {
      const productsGrid = document.getElementById('productsGrid');
      const emptyState = document.getElementById('emptyState');
      
      console.log('Rendering', filteredProducts.length, 'products');
      
      // Show empty state if no products
      if (filteredProducts.length === 0) {
        console.log('No products to display, showing empty state');
        productsGrid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      // Hide empty state
      emptyState.style.display = 'none';
      
      // Clear grid
      productsGrid.innerHTML = '';
      
      // Render products
      filteredProducts.forEach(product => {
        const productCard = createProductCard(product);
        productsGrid.appendChild(productCard);
      });
      
      console.log('Products rendered successfully');
    }

    // Create product card element - FIXED VERSION
    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      
      // Ensure prices are numbers
      const price = parseFloat(product.price) || 0;
      const discountPrice = product.discount_price ? parseFloat(product.discount_price) : null;
      
      // Calculate discount percentage
      const discountPercentage = discountPrice && price > 0 
        ? Math.round(((price - discountPrice) / price) * 100)
        : 0;
      
      // Badges
      let badgeHTML = '';
      if (product.featured) {
        badgeHTML += '<span class="product-badge badge-featured">Featured</span>';
      }
      if (discountPrice && discountPercentage > 0) {
        badgeHTML += `<span class="product-badge badge-sale">${discountPercentage}% OFF</span>`;
      }
      if ((product.stock_quantity || 0) <= 0) {
        badgeHTML += '<span class="product-badge badge-out">Out of Stock</span>';
      }
      
      // Get first image from images array
      let imageUrl = 'https://via.placeholder.com/400x400?text=Product+Image';
      if (product.images) {
        if (Array.isArray(product.images) && product.images.length > 0) {
          imageUrl = product.images[0];
        } else if (typeof product.images === 'string' && product.images.trim() !== '') {
          imageUrl = product.images;
        }
      }
      
      // Safe price formatting
      const formatPrice = (priceValue) => {
        if (isNaN(priceValue) || !isFinite(priceValue)) return '0';
        // Remove decimals for UGX (no cents)
        return Math.round(priceValue).toLocaleString();
      };
      
      const currentPrice = discountPrice || price;
      const originalPrice = discountPrice ? price : null;
      
      card.innerHTML = `
        <div class="product-image">
          ${badgeHTML}
          <img src="${imageUrl}" 
               alt="${product.name || 'Product'}"
               onerror="this.src='https://via.placeholder.com/400x400?text=Image+Not+Found'">
        </div>
        
        <div class="product-info">
          <div class="product-category">${product.category || 'Uncategorized'}</div>
          <h3 class="product-title">
            <a href="product-detail.html?id=${product.id}">${product.name || 'Unnamed Product'}</a>
          </h3>
          
          <div class="product-price">
            <span class="current-price">UGX ${formatPrice(currentPrice)}</span>
            ${originalPrice && originalPrice > 0 ? 
              `<span class="original-price">UGX ${formatPrice(originalPrice)}</span>` : 
              ''}
          </div>
          
          <div class="product-actions">
            <a href="product-detail.html?id=${product.id}" class="btn-details" ${(product.stock_quantity || 0) <= 0 ? 'style="background: var(--gray);"' : ''}>
              <i class="fas fa-eye"></i>
              See Details
            </a>
          </div>
        </div>
      `;
      
      return card;
    }

    // Open filter modal
    function openFilterModal() {
      document.getElementById('filterModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Close filter modal
    function closeFilterModal() {
      document.getElementById('filterModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // Update cart count
    function updateCartCount() {
      try {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
        document.getElementById('cartCount').textContent = totalItems;
      } catch (error) {
        console.error('Error updating cart count:', error);
        document.getElementById('cartCount').textContent = '0';
      }
    }

    // Show notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        left: 20px;
        background: var(--primary);
        color: white;
        padding: 15px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        z-index: 3000;
        animation: slideIn 0.3s ease;
        text-align: center;
      `;
      
      notification.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 8px;"></i>${message}`;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 2000);
      
      // Add CSS for animations
      if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-20px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
    }

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>